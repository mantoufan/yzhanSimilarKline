# ğŸ“ˆ A è‚¡æ•°æ®æ™ºèƒ½åˆ†æç³»ç»Ÿ

## ğŸ“‘ ç›®å½•

1. [ä½œè€…ä¿¡æ¯](#-ä½œè€…ä¿¡æ¯)
2. [ç³»ç»Ÿç®€ä»‹](#-ç³»ç»Ÿç®€ä»‹)
3. [æºç åœ°å€](#-æºç åœ°å€)
4. [Demo æ¼”ç¤º](#-demo)
5. [è‡´è°¢](#-è‡´è°¢)
6. [æ­¥éª¤æ¼”ç¤º](#-æ­¥éª¤æ¼”ç¤º)
7. [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
   - [å®‰è£…æ­¥éª¤](#-å®‰è£…æ­¥éª¤)
   - [ä½¿ç”¨è¯´æ˜](#-ä½¿ç”¨è¯´æ˜)
   - [ä½¿ç”¨æç¤º](#-ä½¿ç”¨æç¤º)
8. [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
9. [æ ¸å¿ƒæŠ€æœ¯å®ç°](#-æ ¸å¿ƒæŠ€æœ¯å®ç°)
   - [K çº¿å½¢æ€è¯†åˆ«ä¸ç›¸ä¼¼åº¦åŒ¹é…](#1-k-çº¿å½¢æ€è¯†åˆ«ä¸ç›¸ä¼¼åº¦åŒ¹é…)
   - [æ™ºèƒ½é—®ç­”ç³»ç»Ÿ](#2-æ™ºèƒ½é—®ç­”ç³»ç»Ÿ)
   - [æ•°æ®å¤„ç†ä¼˜åŒ–](#3-æ•°æ®å¤„ç†ä¼˜åŒ–)
   - [æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜æœºåˆ¶](#4-æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜æœºåˆ¶)
10. [ç³»ç»Ÿç‰¹ç‚¹](#-ç³»ç»Ÿç‰¹ç‚¹)
11. [æ³¨æ„äº‹é¡¹](#-æ³¨æ„äº‹é¡¹)
12. [æ€»ç»“ä¸å±•æœ›](#-æ€»ç»“ä¸å±•æœ›)

---

## ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯

å§“åï¼šå´å°å®‡
å­¦å·ï¼š71265700016
è¯¾ç¨‹ï¼šå•†ä¸šæ™ºèƒ½æŠ€æœ¯
è€å¸ˆï¼šé˜®å…‰å†Œæ•™æˆ

## ğŸŒŸ ç³»ç»Ÿç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªé¢å‘æŠ•èµ„è€…çš„ A è‚¡å¸‚åœºæ™ºèƒ½åˆ†æç³»ç»Ÿï¼Œæ—¨åœ¨æä¾›å®¢è§‚çš„å¸‚åœºåˆ†æå’ŒæŠ•èµ„å»ºè®®ã€‚ğŸ’¡ å®ƒçš„æ ¸å¿ƒåœ¨äºå°†ä¼ ç»Ÿçš„æŠ€æœ¯åˆ†æå’Œç°ä»£äººå·¥æ™ºèƒ½ç›¸ç»“åˆï¼Œä¸ºå¸‚åœºå†³ç­–æä¾›æ•°æ®æ”¯æŒã€‚

è¿™ä¸ªç³»ç»Ÿæ•´åˆäº†æŠ€æœ¯åˆ†æ ğŸ” å’Œæ™ºèƒ½é—®ç­” ğŸ’¬ åŠŸèƒ½ï¼Œé‡‡ç”¨çš®å°”é€Šç›¸å…³ç³»æ•°å’Œæ¬§æ°è·ç¦»ç­‰ç®—æ³•è¿›è¡Œç›¸ä¼¼ K çº¿å½¢æ€è¯†åˆ«ï¼Œç»“åˆåŸºäºç»Ÿè®¡æ¦‚ç‡çš„ä»·æ ¼èµ°åŠ¿é¢„æµ‹ ğŸ“‰ï¼Œä»¥åŠé€šè¿‡å†å²ç›¸ä¼¼åº¦åŒ¹é…å’Œé£é™©åº¦é‡ï¼ˆæ ‡å‡†å·®/æ³¢åŠ¨ç‡ï¼‰çš„æŒä»“æœŸåˆ†æ ğŸ“Šï¼Œå¹¶åŸºäºå¸‚åœºå®æ—¶æ•°æ®ã€RAG æ£€ç´¢å¢å¼ºç”Ÿæˆå’Œ GPT-4o-mini çš„æ™ºèƒ½é—®ç­”æœåŠ¡ã€‚

ç³»ç»Ÿé‡‡ç”¨ TF-IDF å‘é‡åŒ–ã€SVD é™ç»´ç­‰æœºå™¨å­¦ä¹ ç®—æ³•å’Œè‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯ ğŸ¤–ï¼Œè‡´åŠ›äºé€šè¿‡æ•°æ®é©±åŠ¨çš„æ–¹å¼ä¸ºæŠ•èµ„å†³ç­–æä¾›å‚è€ƒã€‚ç³»ç»Ÿè®¾è®¡çš„ç›®æ ‡æ˜¯å¸®åŠ©æŠ•èµ„è€…æ›´å…¨é¢åœ°äº†è§£å¸‚åœºä¿¡æ¯ï¼Œç†æ€§æƒè¡¡æŠ•èµ„é£é™©ã€‚âš–ï¸

## ğŸ”— æºç åœ°å€

[GitHub ä»“åº“](https://github.com/mantoufan/yzhanSimilarKline)

## ğŸ¥ Demo

åœ¨çº¿ä½¿ç”¨ï¼š[é˜¿é‡Œäº‘èŠ‚ç‚¹ï¼ˆæ¨èï¼Œé«˜é€Ÿï¼‰](https://a.os120.com/)ã€€[è°·æ­Œäº‘èŠ‚ç‚¹ï¼ˆæ…¢ï¼‰](https://skline.streamlit.app/)  
è§†é¢‘æ¼”ç¤ºï¼š[ç‚¹å‡»æ’­æ”¾](https://drfs.ctcontents.com/file/3312/1449237316/62baf7/yun/business-ai-demo.mp4)  
åŠ¨ç”»æ¼”ç¤ºï¼š  
![Screenity video - Jan 20, 2025](https://github.com/user-attachments/assets/ea639765-9e44-486a-a753-4841fdf1bc2d)

## ğŸ™ è‡´è°¢

ç‰¹åˆ«æ„Ÿè°¢é˜®å…‰å†Œæ•™æˆåœ¨å•†ä¸šæ™ºèƒ½æŠ€æœ¯è¯¾ç¨‹ä¸­å¯¹ç›¸å…³æŠ€æœ¯å’Œæ¡ˆä¾‹çš„è®²è§£ï¼Œå—ç›ŠåŒªæµ…ã€‚æ•™æˆçš„æŒ‡å¯¼å¸®åŠ©æˆ‘æ›´æ·±å…¥åœ°ç†è§£äº†å•†ä¸šæ™ºèƒ½æŠ€æœ¯çš„å®é™…åº”ç”¨ï¼Œä¸ºæœ¬é¡¹ç›®çš„å¼€å‘æä¾›äº†å®è´µçš„ç†è®ºä¾æ®å’Œæ€è·¯æ–¹å‘ã€‚ğŸ‘¨â€ğŸ«

## ğŸ“· æ­¥éª¤æ¼”ç¤º

æ­¥éª¤ 1ï¼šæœç´¢ å¹³å®‰ / ä¸Šè¯æŒ‡æ•° å…³é”®è¯ï¼Œå…¶å®ƒå…³é”®è¯æ²¡æœ‰ç¼“å­˜å¯èƒ½è¦ç­‰ 5 åˆ†é’Ÿ  
![æœç´¢ç•Œé¢](https://s2.loli.net/2025/01/20/GLUNQcoKB1yTM4p.png)

æ­¥éª¤ 2ï¼šä¸‹æ‹‰æŸ¥çœ‹å†å²ç›¸ä¼¼ K çº¿å›¾  
![Kçº¿åˆ†æ](https://s2.loli.net/2025/01/20/LprhMDcY7HvoqkA.png)

æ­¥éª¤ 3ï¼šåŸºäºæœ€ç›¸ä¼¼çš„ 10 æ¡å†å² K çº¿ï¼Œé¢„æµ‹æœªæ¥ 7 ä¸ªäº¤æ˜“æ—¥çš„æ¶¨è·Œæƒ…å†µ  
![è¶‹åŠ¿é¢„æµ‹](https://s2.loli.net/2025/01/20/PROF6TxjEzoQtqw.png)

æ­¥éª¤ 4ï¼šå¦‚æœå½“å‰äº¤æ˜“æ—¥ï¼ˆéäº¤æ˜“æ—¥æœ€è¿‘ï¼‰ï¼ŒæŒæœ‰ 1 - 7 äº¤æ˜“æ—¥çš„æ”¶ç›Šç‡å’Œèƒœç‡  
![æ”¶ç›Šåˆ†æ](https://s2.loli.net/2025/01/20/akrZ4QdLlyoSKIi.png)

æ­¥éª¤ 5ï¼šæ®ç”¨æˆ·è¾“å…¥é—®é¢˜ï¼ŒæŸ¥è¯¢æœ€ç›¸ä¼¼çš„ï¼Œå°†ç»“æ„åŒ–æ•°æ®è¯­ä¹‰åŒ–çš„ä¸åŒç±»å‹çš„æ•°æ®å—ï¼ŒåµŒå…¥æç¤ºè¯  
![æ•°æ®æ£€ç´¢](https://s2.loli.net/2025/01/20/XR9diAVMw2SZOlo.png)

æ­¥éª¤ 6ï¼šæ ¹æ®å†…ç½® + é—®é¢˜ + åµŒå…¥æ•°æ®å—çš„æç¤ºè¯å‘ç»™ GPT-4o-miniï¼Œè¿”å›ç»“æœ
![æ™ºèƒ½å›ç­”](https://s2.loli.net/2025/01/20/OTaFQSLXkJ24xum.png)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ğŸ’» å®‰è£…æ­¥éª¤

1. å…‹éš†é¡¹ç›®ä»£ç 

```bash
git clone https://github.com/mantoufan/yzhanSimilarKline.git
cd yzhanSimilarKline
```

2. åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. å®‰è£…ä¾èµ–åŒ…

```bash
pip install -r requirements.txt
```

4. é…ç½®ç¯å¢ƒå˜é‡
   åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º`.env`æ–‡ä»¶ï¼Œæ·»åŠ å¿…è¦çš„é…ç½®ï¼š

```
API_KEY=your_api_key
API_BASE=https://api.openai.com
MODEL=gpt-4o-mini
PROXY_URL=your_proxy_url # å¯é€‰ï¼Œç”¨äºè·å–å…¬å¼€é‡‘èæ•°æ®
```

5. å¯åŠ¨åº”ç”¨

```bash
streamlit run streamlit_app.py
```

### ğŸ•¹ï¸ ä½¿ç”¨è¯´æ˜

1. **è¯åˆ¸æœç´¢**ğŸ”ï¼š

   - åœ¨æœç´¢æ¡†è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°
   - ç³»ç»Ÿä¼šæ˜¾ç¤ºåŒ¹é…çš„è¯åˆ¸åˆ—è¡¨ï¼ŒåŒ…æ‹¬è‚¡ç¥¨ã€æŒ‡æ•°å’Œ ETF
   - æ”¯æŒæ¨¡ç³Šæœç´¢å’Œæ™ºèƒ½åŒ¹é…

2. **K çº¿åˆ†æ**ğŸ“ˆï¼š

   - ç‚¹å‡»æ„Ÿå…´è¶£çš„è¯åˆ¸æŸ¥çœ‹è¯¦æƒ…
   - æŸ¥çœ‹ K çº¿å›¾å’Œç›¸ä¼¼å½¢æ€åˆ†æ
   - ç ”ç©¶è¶‹åŠ¿é¢„æµ‹å’Œé£é™©åˆ†æç»“æœ

3. **æ™ºèƒ½é—®ç­”**ğŸ’¬ï¼š

   - åœ¨é—®ç­”è¾“å…¥æ¡†è¾“å…¥æ‚¨çš„é—®é¢˜
   - ç³»ç»Ÿä¼šåŸºäºå¸‚åœºæ•°æ®æä¾›ä¸“ä¸šåˆ†æ
   - æ”¯æŒå¤šè½®å¯¹è¯å’Œæ·±åº¦åˆ†æ

4. **æ•°æ®å¯¼å‡º**ğŸ“¥ï¼š
   - æ”¶ç›Šé¢„æµ‹è¡¨å¯ä»¥å¯¼å‡º CSV
   - K çº¿å›¾å¯ä»¥ä¿å­˜ä¸º PNG æ ¼å¼

### âš ï¸ ä½¿ç”¨æç¤º

- å»ºè®®ä½¿ç”¨ Chrome æˆ– Firefox æµè§ˆå™¨è·å¾—æœ€ä½³ä½“éªŒ ğŸ‘Œ
- é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ç¼“å­˜ç”Ÿæˆ â³
- å›¾è¡¨æ”¯æŒç¼©æ”¾ã€å¹³ç§»ç­‰äº¤äº’æ“ä½œ ğŸ–±ï¸
- æ™ºèƒ½é—®ç­”æ”¯æŒå¤šè½®å¯¹è¯ ğŸ’­

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff' }}}%%
graph TD
    %% Node Styles
    classDef default fill:#ffffff,stroke:#666,stroke-width:2px
    classDef inputClass fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef searchClass fill:#fff8e1,stroke:#f57f17,stroke-width:3px
    classDef dataClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef analysisClass fill:#fce4ec,stroke:#c2185b,stroke-width:3px
    classDef qaClass fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px
    classDef visualClass fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef cacheClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px

    A[ç”¨æˆ·è¾“å…¥æŸ¥è¯¢]:::inputClass
    B[è¯åˆ¸æœç´¢æ¨¡å—]:::searchClass
    C[å¸‚åœºæ•°æ®è·å–]:::dataClass
    D[æ•°æ®ç¼“å­˜å±‚]:::cacheClass

    %% Technical Analysis
    subgraph TA[æŠ€æœ¯åˆ†æå¼•æ“]
        E[Kçº¿å½¢æ€åˆ†æ]:::analysisClass
        F[ç›¸ä¼¼åº¦è®¡ç®—]:::analysisClass
        G[è¶‹åŠ¿é¢„æµ‹]:::analysisClass
        H[é£é™©åˆ†æ]:::analysisClass
    end

    %% Q&A System
    subgraph QA[æ™ºèƒ½é—®ç­”ç³»ç»Ÿ]
        I[æ–‡æœ¬å—æ„å»º]:::qaClass
        J[å‘é‡åŒ–æ£€ç´¢]:::qaClass
        K[LLMé—®ç­”ç”Ÿæˆ]:::qaClass
    end

    %% Visualization
    subgraph VIZ[æ•°æ®å¯è§†åŒ–]
        L[Kçº¿å›¾è¡¨]:::visualClass
        M[ç›¸ä¼¼åº¦å±•ç¤º]:::visualClass
        N[é¢„æµ‹ç»“æœ]:::visualClass
        O[é£é™©æŒ‡æ ‡]:::visualClass
    end

    %% Connections
    A --> B
    B --> C
    C <--> D
    C --> E
    E --> F
    F --> G
    G --> H
    C --> I
    I --> J
    J --> K
    E & F & G & H --> L & M & N & O
    K --> O

    %% Subgraph Styles
    style TA fill:#ffffff,stroke:#666,stroke-width:3px
    style QA fill:#ffffff,stroke:#666,stroke-width:3px
    style VIZ fill:#ffffff,stroke:#666,stroke-width:3px
```

## ğŸ“¦ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. K çº¿å½¢æ€è¯†åˆ«ä¸ç›¸ä¼¼åº¦åŒ¹é…

ç³»ç»Ÿä½¿ç”¨çš®å°”é€Šç›¸å…³ç³»æ•°å’Œæ¬§æ°è·ç¦»çš„ç»„åˆæ–¹æ³•æ¥è¯†åˆ«ç›¸ä¼¼ K çº¿å½¢æ€ã€‚é€šè¿‡å¯¹ä»·æ ¼åºåˆ—è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼Œä½¿å¾—ä¸åŒæ—¶æœŸã€ä¸åŒä»·ä½çš„ K çº¿å¯ä»¥è¿›è¡Œæ¯”è¾ƒï¼š

```python
def normalize_window(window):
    """å¯¹ä»·æ ¼åºåˆ—è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†"""
    numeric_window = pd.to_numeric(window, errors='coerce')
    if numeric_window.isna().any():
        return None
    return (numeric_window - numeric_window.iloc[0]) / numeric_window.iloc[0] * 100

def calculate_similarity(window1, window2):
    """è®¡ç®—ä¸¤ä¸ªä»·æ ¼åºåˆ—çš„ç›¸ä¼¼åº¦"""
    if len(window1) != len(window2):
        return 0

    norm1 = normalize_window(window1)
    norm2 = normalize_window(window2)

    if norm1 is None or norm2 is None:
        return 0

    try:
        # è®¡ç®—ç›¸å…³ç³»æ•°ï¼ˆ-1åˆ°1ä¹‹é—´ï¼‰
        corr, _ = pearsonr(norm1, norm2)
        # è®¡ç®—æ¬§æ°è·ç¦»å¹¶å½’ä¸€åŒ–
        dist = euclidean(norm1, norm2)
        normalized_dist = 1 / (1 + dist/len(window1))
        # åŠ æƒå¹³å‡å¾—åˆ°æœ€ç»ˆç›¸ä¼¼åº¦
        similarity = (corr + 1)/2 * 0.7 + normalized_dist * 0.3
        return similarity
    except:
        return 0
```

æ ¸å¿ƒæŠ€æœ¯ç‰¹ç‚¹ï¼š

- **æ—¶é—´åºåˆ—å¤„ç†**ğŸ•°ï¸ï¼šä½¿ç”¨ pandas çš„ DatetimeIndex å¤„ç† K çº¿æ•°æ®
- **ç»Ÿè®¡å­¦æ–¹æ³•**ğŸ“Šï¼š
  - çš®å°”é€Šç›¸å…³ç³»æ•°ï¼šè¡¡é‡ä»·æ ¼åºåˆ—çš„èµ°åŠ¿ç›¸å…³æ€§
  - æ¬§æ°è·ç¦»ï¼šè¯„ä¼°ä»·æ ¼åºåˆ—çš„å½¢æ€å·®å¼‚
- **æ•°æ®æ ‡å‡†åŒ–**ğŸšï¸ï¼šåŸºäºé¦–æ—¥ä»·æ ¼çš„ç™¾åˆ†æ¯”å˜åŒ–

### 2. æ™ºèƒ½é—®ç­”ç³»ç»Ÿ

ç³»ç»Ÿé‡‡ç”¨ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æŠ€æœ¯æ¶æ„ï¼Œç»“åˆå‘é‡åŒ–æ£€ç´¢å’Œå¤§è¯­è¨€æ¨¡å‹ï¼š

```python
def create_text_chunks(security, current_df, similar_patterns, holding_stats):
    """æ„å»ºç»“æ„åŒ–æ–‡æœ¬å—ä¾›æ£€ç´¢"""
    chunks = []

    # æ„å»ºåŸºæœ¬ä¿¡æ¯æ–‡æœ¬å—
    basic_info = f"""
        è¯åˆ¸åŸºæœ¬ä¿¡æ¯ï¼š
        åç§°ï¼š{security['name']}
        ä»£ç ï¼š{security['code']}
        ç±»å‹ï¼š{security['type']}
        äº¤æ˜“æ‰€ï¼š{security['exchange']}
    """
    chunks.append(("basic_info", basic_info))

    if current_df is not None and not current_df.empty:
        # æ·»åŠ æœ€æ–°è¡Œæƒ…ä¿¡æ¯
        latest_data = current_df.iloc[-1]
        latest_market = f"""
        æœ€æ–°å¸‚åœºè¡Œæƒ…ï¼ˆ{latest_data['trade_date'].strftime('%Y-%m-%d')}ï¼‰ï¼š
        æ”¶ç›˜ä»·ï¼š{latest_data['close']:.2f}
        å¼€ç›˜ä»·ï¼š{latest_data['open']:.2f}
        æœ€é«˜ä»·ï¼š{latest_data['high']:.2f}
        æœ€ä½ä»·ï¼š{latest_data['low']:.2f}
        æˆäº¤é‡ï¼š{latest_data.get('volume', 'æœªçŸ¥')}
        """
        chunks.append(("latest_market", latest_market))

    return chunks

class ChineseTextVectorizer:
    """ä¸­æ–‡æ–‡æœ¬å‘é‡åŒ–å¤„ç†å™¨"""
    def __init__(self, vector_size=100):
        self.tfidf = TfidfVectorizer(
            tokenizer=self._parallel_tokenize,  # ä½¿ç”¨å¹¶è¡Œåˆ†è¯å¤„ç†å™¨
            max_features=2000
        )
        self.svd = TruncatedSVD(
            n_components=vector_size,
            random_state=42
        )
        self.is_fitted = False
        jieba.initialize()

    @lru_cache(maxsize=1000)
    def _tokenize(self, text):
        """åŸºç¡€åˆ†è¯æ–¹æ³•ï¼Œå¸¦æœ‰ç¼“å­˜ä¼˜åŒ–"""
        text = re.sub(r'[^\w\s]', '', text)
        words = jieba.lcut(text)
        return [w for w in words if w.strip()]

    def _parallel_tokenize(self, text):
        """
        å¹¶è¡Œåˆ†è¯å¤„ç†å™¨ï¼Œé’ˆå¯¹é•¿æ–‡æœ¬ä¼˜åŒ–
        - çŸ­æ–‡æœ¬ï¼ˆ<1000å­—ç¬¦ï¼‰ç›´æ¥å¤„ç†
        - é•¿æ–‡æœ¬ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œåˆ†è¯
        """
        if len(text) < 1000:
            return self._tokenize(text)

        chunks = self._split_text(text)
        with ThreadPoolExecutor(max_workers=4) as executor:
            results = list(executor.map(self._tokenize, chunks))
        return [token for chunk_result in results for token in chunk_result]
```

### 3. æ•°æ®å¤„ç†ä¼˜åŒ–

ç³»ç»Ÿå®ç°äº†æ–‡ä»¶ç¼“å­˜æœºåˆ¶æ¥æå‡æ€§èƒ½ï¼š

```python
@file_cache(cache_dir="./securities_cache", expire_days=30)
def load_security_data(security_type: str) -> pd.DataFrame:
    """åŠ è½½è¯åˆ¸æ•°æ®ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶ç¼“å­˜"""
    try:
        if security_type == 'index':
            return adata.stock.info.all_index_code()
        elif security_type == 'stock':
            return adata.stock.info.all_code()
        elif security_type == 'etf':
            return adata.fund.info.all_etf_exchange_traded_info()
        else:
            return pd.DataFrame()
    except Exception as e:
        print(f"åŠ è½½{security_type}æ•°æ®æ—¶å‡ºé”™: {str(e)}")
        return pd.DataFrame()

def search_securities(query: str) -> List[Dict]:
    """æœç´¢è¯åˆ¸(æŒ‡æ•°ã€è‚¡ç¥¨)"""
    if not query or len(query.strip()) == 0:
        return []

    # é¢„å¤„ç†æŸ¥è¯¢å…³é”®è¯
    query = preprocess_query(query)

    # ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œæœç´¢ä¸åŒç±»å‹çš„è¯åˆ¸
    security_types = ['index', 'stock', 'etf']
    with ThreadPoolExecutor(max_workers=2) as executor:
        futures = [
            executor.submit(search_single_type, query, security_type)
            for security_type in security_types
        ]

        # æ”¶é›†æ‰€æœ‰ç»“æœ
        all_results = []
        for future in futures:
            try:
                results = future.result()
                all_results.extend(results)
            except Exception as e:
                print(f"è·å–æœç´¢ç»“æœæ—¶å‡ºé”™: {str(e)}")

    # æŒ‰ç›¸å…³åº¦æ’åºç»“æœ
    all_results.sort(key=lambda x: (
        -int(x['code'].lower() == query),  # å®Œå…¨åŒ¹é…ä»£ç çš„ä¼˜å…ˆçº§æœ€é«˜
        -int(query in x['code'].lower()),  # å…¶æ¬¡æ˜¯åŒ…å«ä»£ç çš„
        -int(query in x['name'].lower()),  # å†æ¬¡æ˜¯åŒ…å«åç§°çš„
        len(x['code'])  # æœ€åæŒ‰ä»£ç é•¿åº¦æ’åº
    ))

    return all_results
```

### 4. æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜æœºåˆ¶

ç³»ç»Ÿé€šè¿‡æ–‡ä»¶ç¼“å­˜æœºåˆ¶æ¥æå‡æ•°æ®åŠ è½½æ€§èƒ½ï¼š

```python
def file_cache(cache_dir="./data_cache", expire_days=1):
    """æ–‡ä»¶ç¼“å­˜è£…é¥°å™¨ï¼Œå°†æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ"""
    def decorator(func):
        def wrapper(*args, **kwargs):
            # åˆ›å»ºç¼“å­˜ç›®å½•
            os.makedirs(cache_dir, exist_ok=True)

            # æ„å»ºç¼“å­˜æ–‡ä»¶è·¯å¾„
            cache_key = f"{func.__name__}_{str(args)}_{str(kwargs)}"
            cache_file = os.path.join(cache_dir, f"{cache_key}.json")
            meta_file = os.path.join(cache_dir, f"{cache_key}_meta.json")

            # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœŸ
            if os.path.exists(cache_file) and os.path.exists(meta_file):
                with open(meta_file, 'r') as f:
                    meta = json.load(f)
                cache_time = datetime.strptime(meta['timestamp'],
                                             '%Y-%m-%d %H:%M:%S')

                if datetime.now() - cache_time < timedelta(days=expire_days):
                    with open(cache_file, 'r') as f:
                        return json.load(f)

            # è·å–æ–°æ•°æ®å¹¶ç¼“å­˜
            results = func(*args, **kwargs)

            try:
                with open(cache_file, 'w') as f:
                    json.dump(results, f, ensure_ascii=False, indent=2)

                meta = {
                    'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    'function': func.__name__,
                    'args': str(args),
                    'kwargs': str(kwargs)
                }
                with open(meta_file, 'w') as f:
                    json.dump(meta, f, ensure_ascii=False, indent=2)

            except Exception as e:
                print(f"å†™å…¥ç¼“å­˜æ–‡ä»¶å‡ºé”™: {str(e)}")

            return results
        return wrapper
    return decorator
```

## â­ ç³»ç»Ÿç‰¹ç‚¹

1. **é«˜æ•ˆæ•°æ®å¤„ç†**ğŸš€ï¼š

   - æ–‡ä»¶ç¼“å­˜æœºåˆ¶ï¼Œæé«˜æ•°æ®åŠ è½½é€Ÿåº¦ ğŸ’¾
   - ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œæœç´¢ä¸åŒç±»å‹è¯åˆ¸ ğŸ§µ
   - LRU ç¼“å­˜ä¼˜åŒ–åˆ†è¯ç»“æœ â³
   - é•¿æ–‡æœ¬çš„å¹¶è¡Œåˆ†è¯å¤„ç† âš¡

2. **ç²¾å‡†åˆ†æå¼•æ“**ğŸ§ ï¼š

   - åŸºäºçš®å°”é€Šç›¸å…³ç³»æ•°å’Œæ¬§æ°è·ç¦»çš„ K çº¿ç›¸ä¼¼åº¦è®¡ç®— ğŸ§®
   - TF-IDF å’Œ SVD çš„æ–‡æœ¬å‘é‡åŒ–å¤„ç† ğŸ¯
   - åŸºäºç»Ÿè®¡çš„é£é™©æ”¶ç›Šåˆ†æ ğŸ“‰

3. **ç”¨æˆ·å‹å¥½ç•Œé¢**ğŸ‘¨â€ğŸ’»ï¼š
   - æ¸…æ™°çš„æ•°æ®å¯è§†åŒ– ğŸ“Š
   - ç®€æ´çš„æœç´¢åŠŸèƒ½ ğŸ”
   - æ™ºèƒ½çš„é—®ç­”ç³»ç»Ÿ ğŸ’¬

## âš ï¸ æ³¨æ„äº‹é¡¹

1. æ‰€æœ‰åˆ†æç»“æœä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®® âŒ
2. è¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š ğŸ“‰
3. æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ… âš ï¸

## ğŸ‰ æ€»ç»“ä¸å±•æœ›

åœ¨ A è‚¡æ™ºèƒ½åˆ†æç³»ç»Ÿçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ¬é¡¹ç›®ä¸»è¦å–å¾—äº†ä»¥ä¸‹æˆæœï¼š

1. å®ç°äº†åŸºäºçš®å°”é€Šç›¸å…³ç³»æ•°å’Œæ¬§æ°è·ç¦»çš„ K çº¿å½¢æ€è¯†åˆ«
2. æ„å»ºäº†æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿæå‡æ•°æ®åŠ è½½æ€§èƒ½
3. å¼€å‘äº†åŸºäº TF-IDF å’Œ SVD çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ
4. é›†æˆäº†å¸‚åœºæ•°æ®åˆ†æå’Œé£é™©è¯„ä¼°åŠŸèƒ½

åŒæ—¶ä¹Ÿå‘ç°äº†ä¸€äº›å¯ä»¥æ”¹è¿›çš„æ–¹å‘ï¼š

1. ğŸŒ æ¥å£é€Ÿåº¦ï¼šç›®å‰é‡‡ç”¨çš„å…è´¹å…¬ç”¨æ¥å£åœ¨çº¿ä¸Šè¿è¡Œæ—¶é€Ÿåº¦è¾ƒæ…¢ï¼Œå¯ä»¥è€ƒè™‘å‡çº§åˆ°æ›´å¿«çš„æ•°æ®æœåŠ¡ã€‚

2. ğŸŒ Web æ¡†æ¶é€‰æ‹©ï¼šStreamlit è™½ç„¶å¼€å‘ä¾¿æ·ï¼Œä½†åœ¨æ€§èƒ½ä¸Šå­˜åœ¨ä¸€å®šé™åˆ¶ï¼Œæœªæ¥å¯ä»¥è¯„ä¼°å…¶ä»–æ›´é«˜æ€§èƒ½çš„æ¡†æ¶ã€‚

3. ğŸ“Š K çº¿åˆ†ææ·±åº¦ï¼šå¯ä»¥è€ƒè™‘å¼•å…¥æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ï¼Œæä¾›æ›´å…¨é¢çš„å¸‚åœºåˆ†æã€‚

4. ğŸ’¡ AI æ¨¡å‹ä¼˜åŒ–ï¼šå¯ä»¥æ¢ç´¢æ›´å…ˆè¿›çš„è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡å‹ï¼Œæå‡æ™ºèƒ½é—®ç­”çš„è´¨é‡ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªé¡¹ç›®å®ç°äº†æŠ€æœ¯åˆ†æä¸äººå·¥æ™ºèƒ½çš„åŸºç¡€ç»“åˆï¼Œä¸ºæŠ•èµ„å†³ç­–æä¾›äº†æ•°æ®æ”¯æŒã€‚æœªæ¥å°†ç»§ç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Œå®Œå–„åˆ†æåŠŸèƒ½ï¼Œä¸ºæŠ•èµ„è€…æä¾›æ›´ä¸“ä¸šçš„å¸‚åœºåˆ†æå·¥å…·ã€‚
